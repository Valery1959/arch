#!/bin/bash

script_dir=$(cd $(dirname $0); pwd -P)

source $script_dir/utils.sh

file=/etc/mkinitcpio.conf; [ ! -f $file ] && { echo "File $file does not exist" ; exit 1; }

# -------------------------------------------------
# 1. Install NVIDIA drivers 
# -------------------------------------------------
echo ""
echo "-----------------------------------------------"
echo "Install NVIDIA drivers"
echo "-----------------------------------------------"

echo "--- Update system ..."
run sudo pacman -Syu  

# detect GPU, and if it is not nvidia, then do not install NVIDIA drivers
grep_pci_devices "nvidia" || { echo "NVIDIA device not found, skipping NVIDIA drivers installation" ; exit 0; }

# Turing (NV160/TUXXX) and newer requires the following driver:
#   nvidia-open for linux
#   nvidia-open-lts for linux-lts
#   nvidia-open-dkms for any kernel(s)
#
#   nvidia-open        - nvida driver
#   nvidia-utils       - nvidia-libgl, opengl-driver, vulkan-driver
#   lib32-nvidia-utils - OpenGL (multilib) for 32-bit applications from the multilib repository
#   nvidia-settings    - Tool for configuring the NVIDIA graphics driver
#
# note, that lib32-nvidia-utils requires the following lines to be enabled in /etc/pacman.conf
# [multilib]
# Include = /etc/pacman.d/mirrorlist

echo "--- installing NVIDIA drivers ..."
run sudo pacman -S --needed --noconfirm linux-headers nvidia-open nvidia-utils lib32-nvidia-utils nvidia-settings

# Add module to /etc/mkinitcpio.conf
add_module()
{
   grep -qE '^MODULES=\(\)' "$file" || { p=' '; grep -qE '^MODULES=\(.*\b'${1}'\b.*\)' "$file" && return; }

   echo "--- Add module $1 to /etc/mkinitcpio.conf"
   sudo sed -i -e 's/\(MODULES=.*\)\()\)/\1'"${p}${1}"')/g' $file
}

modules="nvidia nvidia_modeset nvidia_uvm nvidia_drm"

for m in $modules
do
   add_module $m
done

echo "--- Remove kms from HOOKS in /etc/mkinitcpio.conf"
sudo sed -i -e 's/\(HOOKS=.*\)\(\s\)\(\bkms\b\)\(.*\)/\1\4/g' $file

echo "--- Re-generate initramfs"
sudo mkinitcpio -P

echo "--- Add the Pacman Hook"
run sudo mkdir -p /etc/pacman.d/hooks
run sudo cp $script_dir/extra/config/nvidia/nvidia.hook /etc/pacman.d/hooks

exit 0

